apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: starcoin
  namespace: starcoin-main
  labels:
    app: starcoin
    network: main
spec:
  selector:
    matchLabels:
      app: starcoin
  serviceName: starcoin-svc
  replicas: 3
  template:
    metadata:
      name: starcoin
      labels:
        app: starcoin
        network: main
    spec:
      nodeSelector:
        starcoin/node-pool: seed-pool
      # starcoin template
      containers:
        - name: starcoin
          image: ghcr.io/starcoinorg/starcoin:v1.13.20
          imagePullPolicy: Always
          command:
            - sh
            - -c
          args:
            - |
              rm -rf /sc-data/main/starcoin.ipc /sc-data/main/starcoindb/db/starcoindb/LOCK
              /starcoin/starcoin -n main --discover-local true --disable-miner-client true --min-peers-to-propagate 512 --max-peers-to-propagate 1024 --max-outgoing-peers 512 --max-incoming-peers 512 -d /sc-data
          ports:
            - containerPort: 9840
          volumeMounts:
            - name: starcoin-volume
              mountPath: /sc-data
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name

          livenessProbe:
            tcpSocket:
              port: 9840
            initialDelaySeconds: 20
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 4
            successThreshold: 1
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - >-
                  /starcoin/starcoin -n main -d /sc-data node sync status|grep Synchronized
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 3
            successThreshold: 1
  volumeClaimTemplates:
    - metadata:
        name: starcoin-volume
        namespace: starcoin-main
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 500Gi
        storageClassName: do-block-storage
        dataSource:
          name: migration-seed-do-snapshot
          kind: VolumeSnapshot
          apiGroup: snapshot.storage.k8s.io