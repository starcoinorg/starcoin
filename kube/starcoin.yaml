apiVersion: v1
kind: Service
metadata:
  name: starcoin
spec:
  selector:
    app: starcoin
  ports:
    -
      protocol: TCP
      port: 9840
      targetPort: 9840
      name: peer
  clusterIP: None
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: starcoin
  labels:
    app: starcoin
    network: proxima
spec:
  selector:
    matchLabels:
      app: starcoin
      network: proxima
  serviceName: starcoin
  replicas: 3
  template:
    metadata:
      labels:
        app: starcoin
        network: proxima
    spec:
      containers:
      - name: starcoin
        image: starcoin/starcoin:v0.4.3
        command:
          - bash
          - -c
        args:
          -
            rm -rf /data/proxima/*;
            if [ $POD_NAME = "starcoin-0" ]; then
              /starcoin/starcoin -n proxima -d /data --disable-seed --node-key $(SEED_KEY);
              sleep 5;
            else
              id=$(echo -e $POD_NAME|awk -F'-' '{print $2}') && IFS='; ' read -r -a node_keys <<< $NODE_KEYS &&
              /starcoin/starcoin -n proxima -d /data --seed $(SEED) --node-key ${node_keys[$id]};
            fi
            
        ports:
          - containerPort: 9840
            hostPort: 9840
        volumeMounts:
        - name: volume
          mountPath: /data
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: NODE_KEYS
            valueFrom:
              configMapKeyRef:
                name: starcoin-config
                key: node_keys

          - name: SEED_KEY
            valueFrom:
              configMapKeyRef:
                name: starcoin-config
                key: seed_key

          - name: SEED_PEER_ID
            valueFrom:
              configMapKeyRef:
                name: starcoin-config
                key: seed_peer_id
                
          - name: SEED
            value: /dns4/starcoin-0.starcoin.default.svc.cluster.local/tcp/9840/p2p/$SEED_PEER_ID
            
      volumes:
      - name: volume
        hostPath:
          path: /data
          
