---
id: multisig-account
title: 多签账户以及多签交易
---

# 多签账户和多签交易

本节介绍多签账户的使用，包括如何创建通过 cli 在链上创建多签账户，以及如何发起多签交易。

## 前置准备

请保证

1. starcoin 节点已经启动。
2. 已经启动 cli 连接到节点。
3. wallet 存在至少三个地址。
4. 已经通过 `dev get_coin` 给默认的钱包地址充钱。

下图是我的初始状态。

```bash
starcoin% account list
+----------------------------------+------------+------------------------------------------------------------------+
| address                          | is_default | public_key                                                       |
+----------------------------------+------------+------------------------------------------------------------------+
| 2a3a2feefb08a61450e8c84b5ca86cfb | false      | 908648b8fdff8b9e337b2e546c0ce5ca6f24dee715de0782e2f7943c677b6284 |
+----------------------------------+------------+------------------------------------------------------------------+
| 9503b1e9052e6c5cc0b4f9e8d303fa83 | false      | ca9eb069f655145d1bf61829e59ef5c70ac10c8acf0d1a6ffadd1a40505d3283 |
+----------------------------------+------------+------------------------------------------------------------------+
| 6142815e14be403fef8048b945cd4685 | true       | 37283fa8e0b2aa1df9567104d72053c3ee6947bf96559a9a8452870f9d2b5dcf |
+----------------------------------+------------+------------------------------------------------------------------+
```

给默认钱包地址充钱。

```bash
starcoin% dev get_coin
txn mined in block hight: 1, hash: b75bbe0ac17639d746a823a67b278e892cd635aa83ca66694e374d059527e6cf
+-----------------+------------------------------------------------------------------+
| gas_unit_price  | 1                                                                |
+-----------------+------------------------------------------------------------------+
| id              | 865e314c93bc51eeb19599e8c87a10734d539494c90f2f9b0bb765e64f67c3e3 |
+-----------------+------------------------------------------------------------------+
| max_gas_amount  | 2000000                                                          |
+-----------------+------------------------------------------------------------------+
| sender          | 0000000000000000000000000a550c18                                 |
+-----------------+------------------------------------------------------------------+
| sequence_number | 1                                                                |
+-----------------+------------------------------------------------------------------+

starcoin% account show 6142815e14be403fef8048b945cd4685
+--------------------+------------------------------------------------------------------+
| account.address    | 6142815e14be403fef8048b945cd4685                                 |
+--------------------+------------------------------------------------------------------+
| account.is_default | true                                                             |
+--------------------+------------------------------------------------------------------+
| account.public_key | 37283fa8e0b2aa1df9567104d72053c3ee6947bf96559a9a8452870f9d2b5dcf |
+--------------------+------------------------------------------------------------------+
| auth_key_prefix    | e1ae28ee72cf133ad170b8a90eda5909                                 |
+--------------------+------------------------------------------------------------------+
| balances.STC       | 84005000000000                                                   |
+--------------------+------------------------------------------------------------------+
| sequence_number    | 0                                                                |
+--------------------+------------------------------------------------------------------+
```

做完上述准备后，下面开始我们的多签交易流程。主要步骤如下：

1. 首先我们在链上创建一个多签账户。
2. 然后从我的默认地址给这个多签账户转一笔钱。
3. 然后发起一个多签交易：从多签账户给我的另外一个地址转账。

## 创建多签账户

这里假设读者了解多签账户的基本概念。

这一小节里，我们会创建一个，由**三个**参与者共同维护的多签账户，交易只需要其中**两个**参与者的签名即可（ `threshold=2` ）。

首先查看，前置准备中要求读者准备的三个地址，以及对应的公钥。

```bash
	starcoin% account list
+----------------------------------+------------+------------------------------------------------------------------+
| address                          | is_default | public_key                                                       |
+----------------------------------+------------+------------------------------------------------------------------+
| 2a3a2feefb08a61450e8c84b5ca86cfb | false      | 908648b8fdff8b9e337b2e546c0ce5ca6f24dee715de0782e2f7943c677b6284 |
+----------------------------------+------------+------------------------------------------------------------------+
| 9503b1e9052e6c5cc0b4f9e8d303fa83 | false      | ca9eb069f655145d1bf61829e59ef5c70ac10c8acf0d1a6ffadd1a40505d3283 |
+----------------------------------+------------+------------------------------------------------------------------+
| 6142815e14be403fef8048b945cd4685 | true       | 37283fa8e0b2aa1df9567104d72053c3ee6947bf96559a9a8452870f9d2b5dcf |
+----------------------------------+------------+------------------------------------------------------------------+
```

然后我们从这三个公钥以及 `threshold=2`  来生成多签账户的地址信息。

- 公钥的顺序不影响生成的地址。内部会根据公钥的bytes做排序。
- `-t 2` 表明 `threshold=2`。

```bash
# 公钥的顺序不影响生成的地址。内部会根据公钥的bytes做排序
starcoin% dev derive-address -t 2 -p ca9eb069f655145d1bf61829e59ef5c70ac10c8acf0d1a6ffadd1a40505d3283 -p 908648b8fdff8b9e337b2e546c0ce5ca6f24dee715de0782e2f7943c677b6284 -p 37283fa8e0b2aa1df9567104d72053c3ee6947bf96559a9a8452870f9d2b5dcf
+-----------------+----------------------------------+
| address         | 0f8a76c7fe8612b3dd6547d54546c1a9 |
+-----------------+----------------------------------+
| auth_key        | e0d3d4c38cb2c3fda21425bbca8822c1bee64e38f075031e6a508459213d2461 |
+-----------------+------------------------------------------------------------------+
| auth_key_prefix | e0d3d4c38cb2c3fda21425bbca8822c1 |
+-----------------+----------------------------------+

```

最后执行 create_account 交易，在链上创建这个账户。命令如下：

```bash
# 从默认地址账户发起交易，创建多签账户，并给这个多签账户转账 1000 STC。
starcoin% dev execute -b --script create_account -t 0x1::STC::STC --arg 0x0f8a76c7fe8612b3dd6547d54546c1a9 --arg x"e0d3d4c38cb2c3fda21425bbca8822c1bee64e38f075031e6a508459213d2461" --arg 10000000u128

txn becac3e5f1605255e6274b7b0a7c8f17262439c123f96f584cbce8d667f0800d submitted.
txn mined in block hight: 5, hash: c20a82c741f5f552b622e797769567dabf577eb00c466d81dff8f9cada5fda45
becac3e5f1605255e6274b7b0a7c8f17262439c123f96f584cbce8d667f0800d
```
- 多签账户和普通账户的创建流程是一样的。只是多签账户的地址信息和 auth_key 的生成依赖多签账户参与者的公钥。
- `-- 0x0f8a76c7fe8612b3dd6547d54546c1a9 x"e0d3d4c38cb2c3fda21425bbca8822c1bee64e38f075031e6a508459213d2461" 10000000u128` 是 `create_account` 的参数，第一个是 多签账户的地址，第二个是多签账户的 `auth_key`，第三个是多签账户初始时的账户余额。
- 如果遇到 `Server returned rpc error Invalid params: account 6142815e14be403fef8048b945cd4685 is locked` 或者类似的错误，请先执行  `account unlock -t 100000 [your-address]` 命令解锁账户。

以上命令执行成功后，多签账户就创建成功了。可以用下面的命令查看这个账户的信息：

```bash
starcoin% dev call --module-address 0x1 --module-name Account --func-name balance -t 0x1::STC::STC --arg 0x0f8a76c7fe8612b3dd6547d54546c1a9

+------+----------+
| type | value    |
+------+----------+
| U128 | 10000000 |
+------+----------+
```

## 给多签账户打钱

虽然我们的多签账户已经有 `10000000` 个 STC 了，但是可能还不够多。

这一小节，我们再从默认钱包地址给这个多签账户转 1000w 个 STC。

```bash
starcoin% account transfer -b -v 10000000 -r 0f8a76c7fe8612b3dd6547d54546c1a9
+-----------------+------------------------------------------------------------------+
| gas_unit_price  | 1                                                                |
+-----------------+------------------------------------------------------------------+
| id              | 170bd4c473f76d29a050a2314e956464cfbf356eadabbac4804785dae34fd53c |
+-----------------+------------------------------------------------------------------+
| max_gas_amount  | 1000000                                                          |
+-----------------+------------------------------------------------------------------+
| sender          | 6142815e14be403fef8048b945cd4685                                 |
+-----------------+------------------------------------------------------------------+
| sequence_number | 1                                                                |
+-----------------+------------------------------------------------------------------+

```

再查看多签账户的信息：

```bash
starcoin% dev call --module-address 0x1 --module-name Account --func-name balance -t 0x1::STC::STC --arg 0x0f8a76c7fe8612b3dd6547d54546c1a9

+------+----------+
| type | value    |
+------+----------+
| U128 | 20000000 |
+------+----------+
```

## 发起多签交易

现在多签账户有了 2000w STC。

我们来发起一个多签交易：从多签账户往我的账户地址（ `2a3a2feefb08a61450e8c84b5ca86cfb` ）转账 500w 个 STC。

```bash
starcoin% dev gen-multisig-txn \
-p 908648b8fdff8b9e337b2e546c0ce5ca6f24dee715de0782e2f7943c677b6284 \
-p ca9eb069f655145d1bf61829e59ef5c70ac10c8acf0d1a6ffadd1a40505d3283 \
-p 37283fa8e0b2aa1df9567104d72053c3ee6947bf96559a9a8452870f9d2b5dcf \
--threshold 2 \
--stdlib-script peer_to_peer \
-t 0x1::STC::STC \
--arg 0x2a3a2feefb08a61450e8c84b5ca86cfb \
--arg x"b549cbd66a9f0a7fe645b21aa740ffad2a3a2feefb08a61450e8c84b5ca86cfb" \
--arg 5000000u128

/Users/annali007/projects/starcoin/28f3bf96.multisig-txn
```

其中 `peer_to_peer` 脚本参数：
- `0x2a3a2feefb08a61450e8c84b5ca86cfb` 是收款人地址。
- `x"b549cbd66a9f0a7fe645b21aa740ffad2a3a2feefb08a61450e8c84b5ca86cfb"` 是收款人的 auth_key。
- `5000000u128` 是要发送的 token 数量。
生成的 txn 会以文件形式保存在当前目录下，文件名是 txn 的 short hash。

拿到这个文件后，将其分发给多签账户的参与者去进行签名。

## 签名

多签账户参与者，可以利用下面的命令对交易签名。

这里我们让如下两个参与者签名（threshold=2）。

- address：9503b1e9052e6c5cc0b4f9e8d303fa83

    public_key: ca9eb069f655145d1bf61829e59ef5c70ac10c8acf0d1a6ffadd1a40505d3283

- address：6142815e14be403fef8048b945cd4685

    public_key: 37283fa8e0b2aa1df9567104d72053c3ee6947bf96559a9a8452870f9d2b5dcf

```bash
starcoin% account partial-sign-txn -i /Users/annali007/projects/starcoin/28f3bf96.multisig-txn -s 9503b1e9052e6c5cc0b4f9e8d303fa83
/Users/annali007/projects/starcoin/28f3bf96.multisig-txn.partial
starcoin% account partial-sign-txn -i /Users/annali007/projects/starcoin/28f3bf96.multisig-txn.partial -s 6142815e14be403fef8048b945cd4685
/Users/annali007/projects/starcoin/28f3bf96.multisig-txn.partial
```

签名会产生一个 partial-signed 的交易文件。该交易文件可以继续分发给其他参与者进行签名。

当然其他参与者也可以直接对原始的交易文件签名，但聚合签名时，需要收集所有交易者的  partial-signed 文件。

## 聚合签名并提交交易

当参与者签名完成后，需要收集到所有的 partial signed 交易文件。

然后利用下面的命令提交多签交易到链上。

- 该命令接受多个文件路径参数。
- 这里只有一个 partial-signed 文件，因为上一小节，第二个参与者是基于第一个参与者签名后的 partial-signed 文件做签名的。

```bash
starcoin% dev submit-multisig-txn -b /Users/annali007/projects/starcoin/28f3bf96.multisig-txn.partial
txn mined in block hight: 9, hash: e591f207743d38825a35230724580b9dd3dd584850a4af52c1f82ed4993bf163
b53a6355e3ed23d81aaae716cb9999233ca2e7611fbceef36d99f870c476971c
```

命令执行完后，我们再查看 `2a3a2feefb08a61450e8c84b5ca86cfb` 地址的账户信息。

可以发现，balances.STC 是 500w，说明转账成功。

```bash
starcoin% account show 2a3a2feefb08a61450e8c84b5ca86cfb
+--------------------+------------------------------------------------------------------+
| account.address    | 2a3a2feefb08a61450e8c84b5ca86cfb                                 |
+--------------------+------------------------------------------------------------------+
| account.is_default | false                                                            |
+--------------------+------------------------------------------------------------------+
| account.public_key | 908648b8fdff8b9e337b2e546c0ce5ca6f24dee715de0782e2f7943c677b6284 |
+--------------------+------------------------------------------------------------------+
| auth_key_prefix    | b549cbd66a9f0a7fe645b21aa740ffad                                 |
+--------------------+------------------------------------------------------------------+
| balances.STC       | 5000000                                                          |
+--------------------+------------------------------------------------------------------+
| sequence_number    | 0                                                                |
+--------------------+------------------------------------------------------------------+
```

## 结语

至此，你已经完成了一个多签账户的创建以及多签交易的生成和链上执行。
